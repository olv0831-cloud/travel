<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paul的分帳神器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print { .no-print { display: none !important; } }
        .active-tab { border-bottom: 4px solid #3b82f6; color: #3b82f6; background: #eff6ff; font-weight: bold; }
        .tab { transition: all 0.3s; cursor: pointer; padding: 8px 16px; border-radius: 99px; display: flex; align-items: center; gap: 8px; }
        .member-col { min-width: 80px; text-align: center; border-left: 1px solid #f1f5f9; }
        .custom-amount-input:focus { outline: none; border-bottom: 1px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLz4iTnKXkba26S4fRUdV6d0DTZiRXSg0",
            authDomain: "travel-expense-7dbaa.firebaseapp.com",
            projectId: "travel-expense-7dbaa",
            storageBucket: "travel-expense-7dbaa.firebasestorage.app",
            messagingSenderId: "745263115640",
            appId: "1:745263115640:web:5714e2c1d041969ecaec8d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tripsRef = doc(db, "travelData", "master_record");

        window.trips = [];
        window.currentTripId = localStorage.getItem('current_trip_id') || "";

        onSnapshot(tripsRef, (docSnap) => {
            if (docSnap.exists()) {
                window.trips = docSnap.data().trips || [];
            } else {
                window.trips = [{ id: Date.now(), name: '我的第一個專案', members: ['Paul'], data: [] }];
                setDoc(tripsRef, { trips: window.trips });
            }
            if (!window.currentTripId && window.trips.length > 0) window.currentTripId = window.trips[0].id;
            refreshAll();
        });

        async function sync() { await setDoc(tripsRef, { trips: window.trips }); }

        window.toggleAllParticipants = (source) => {
            const checkboxes = document.querySelectorAll('.participant-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        };

        window.deleteExpense = async (expenseId) => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            if (confirm("確定要刪除這筆帳目嗎？")) {
                trip.data = trip.data.filter(item => item.id !== expenseId);
                await sync();
            }
        };

        window.exportToCSV = () => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            let csv = "項目,付款人,金額," + trip.members.join(",") + "\n";
            trip.data.forEach(item => {
                let row = `${item.name},${item.payer},${item.amount}`;
                trip.members.forEach(m => {
                    const p = item.participants.find(part => part.name === m);
                    row += p ? `,${Math.round(p.finalShare || 0)}` : ",0";
                });
                csv += row + "\n";
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `${trip.name}_分帳報表.csv`);
            link.click();
        };

        window.addRow = async () => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            const name = document.getElementById('itemName').value;
            const payer = document.getElementById('payer').value;
            const totalAmount = parseFloat(document.getElementById('amount').value);
            const participants = [];
            let totalCustom = 0;
            
            document.querySelectorAll('.participant-row').forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                const customInput = row.querySelector('.custom-amount');
                if (cb.checked) {
                    const customVal = parseFloat(customInput.value) || 0;
                    participants.push({ name: cb.value, customAmount: customVal > 0 ? customVal : null });
                    totalCustom += customVal;
                }
            });

            if (name && payer && !isNaN(totalAmount) && participants.length > 0) {
                if (totalCustom > totalAmount) return alert("自訂金額總和不能超過總金額！");
                // 預先計算分攤
                const customCount = participants.filter(p => p.customAmount !== null).length;
                const remaining = totalAmount - totalCustom;
                const splitCount = participants.length - customCount;
                const avg = splitCount > 0 ? remaining / splitCount : 0;
                
                participants.