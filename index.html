<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paulçš„è¨˜å¸³è»Ÿé«”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print { .no-print { display: none !important; } }
        .active-tab { border-bottom: 4px solid #3b82f6; color: #3b82f6; background: #eff6ff; font-weight: bold; }
        .tab { transition: all 0.3s; cursor: pointer; padding: 8px 16px; border-radius: 99px; display: flex; align-items: center; gap: 8px; }
        .member-tag:hover .remove-member { display: inline; }
        .custom-amount-input:focus { outline: none; border-bottom: 1px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLz4iTnKXkba26S4fRUdV6d0DTZiRXSg0",
            authDomain: "travel-expense-7dbaa.firebaseapp.com",
            projectId: "travel-expense-7dbaa",
            storageBucket: "travel-expense-7dbaa.firebasestorage.app",
            messagingSenderId: "745263115640",
            appId: "1:745263115640:web:5714e2c1d041969ecaec8d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tripsRef = doc(db, "travelData", "master_record");

        window.trips = [];
        window.currentTripId = localStorage.getItem('current_trip_id') || "";

        onSnapshot(tripsRef, (docSnap) => {
            if (docSnap.exists()) {
                window.trips = docSnap.data().trips || [];
            } else {
                window.trips = [{ id: Date.now(), name: 'æˆ‘çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆ', members: ['Paul'], data: [] }];
                setDoc(tripsRef, { trips: window.trips });
            }
            if (!window.currentTripId && window.trips.length > 0) window.currentTripId = window.trips[0].id;
            refreshAll();
        });

        async function sync() {
            await setDoc(tripsRef, { trips: window.trips });
        }

        window.updateTripName = async () => {
            const el = document.getElementById('tripTitle');
            const newName = el.innerText.trim();
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            if (trip && newName && trip.name !== newName) {
                trip.name = newName;
                await sync();
            }
        };

        window.addMember = async () => {
            const name = document.getElementById('newMemberName').value.trim();
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            if (name && !trip.members.includes(name)) {
                trip.members.push(name);
                document.getElementById('newMemberName').value = '';
                await sync();
            }
        };

        window.removeMember = async (name) => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            if (confirm(`ç¢ºå®šç§»é™¤ã€Œ${name}ã€ï¼Ÿ`)) {
                trip.members = trip.members.filter(m => m !== name);
                await sync();
            }
        };

        // æ–°å¢å¸³ç›®é‚è¼¯ (åŒ…å«è‡ªè¨‚é‡‘é¡)
        window.addRow = async () => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            const name = document.getElementById('itemName').value;
            const payer = document.getElementById('payer').value;
            const totalAmount = parseFloat(document.getElementById('amount').value);
            
            const participants = [];
            let totalCustom = 0;
            
            document.querySelectorAll('.participant-row').forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                const customInput = row.querySelector('.custom-amount');
                if (cb.checked) {
                    const customVal = parseFloat(customInput.value) || 0;
                    participants.push({
                        name: cb.value,
                        customAmount: customVal > 0 ? customVal : null
                    });
                    totalCustom += customVal;
                }
            });

            if (name && payer && !isNaN(totalAmount) && participants.length > 0) {
                if (totalCustom > totalAmount) return alert("è‡ªè¨‚é‡‘é¡ç¸½å’Œä¸èƒ½è¶…éç¸½é‡‘é¡ï¼");
                
                trip.data.push({ 
                    id: Date.now(), 
                    name, 
                    payer, 
                    amount: totalAmount, 
                    participants 
                });
                document.getElementById('itemName').value = '';
                document.getElementById('amount').value = '';
                await sync();
            } else {
                alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šä¸¦é¸æ“‡è‡³å°‘ä¸€ä½åƒèˆ‡è€…ï¼");
            }
        };

        window.switchTrip = (id) => {
            window.currentTripId = id;
            localStorage.setItem('current_trip_id', id);
            refreshAll();
        };

        window.deleteTrip = async (e, id) => {
            e.stopPropagation();
            if (confirm(`ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿ`)) {
                window.trips = window.trips.filter(t => t.id !== id);
                window.currentTripId = window.trips.length > 0 ? window.trips[0].id : "";
                await sync();
            }
        };

        window.createNewTrip = async () => {
            const name = prompt('æ–°å°ˆæ¡ˆåç¨±ï¼š', 'æ–°è¨ˆç•«');
            if (name) {
                const newTrip = { id: Date.now(), name, members: ['Paul'], data: [] };
                window.trips.push(newTrip);
                window.currentTripId = newTrip.id;
                await sync();
            }
        };

        function refreshAll() {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId)) || window.trips[0];
            if (!trip) {
                document.body.innerHTML = '<div class="flex flex-col items-center justify-center h-screen"><button onclick="createNewTrip()" class="bg-blue-600 text-white px-6 py-2 rounded-xl">å»ºç«‹æ–°å°ˆæ¡ˆ</button></div>';
                return;
            }

            document.getElementById('tripTitle').innerText = trip.name;
            document.getElementById('tripTabs').innerHTML = window.trips.map(t => `
                <div onclick="switchTrip(${t.id})" class="tab ${String(t.id) === String(window.currentTripId) ? 'active-tab shadow-sm' : 'text-gray-400'} group">
                    <span>${t.name}</span>
                    <i onclick="deleteTrip(event, ${t.id})" class="fa-solid fa-trash-can text-xs hover:text-red-500 opacity-0 group-hover:opacity-100 transition"></i>
                </div>
            `).join('');

            document.getElementById('memberList').innerHTML = trip.members.map(m => `
                <span class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 flex items-center gap-1">
                    ${m} <i onclick="removeMember('${m}')" class="fa-solid fa-times cursor-pointer hover:text-red-500"></i>
                </span>
            `).join('');
            
            // æ–°å¢æ¶ˆè²»çš„äººå“¡æ¸…å–®
            document.getElementById('participantChecks').innerHTML = trip.members.map(m => `
                <div class="participant-row flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                    <label class="flex items-center space-x-2 truncate">
                        <input type="checkbox" value="${m}" checked class="w-4 h-4 text-blue-600">
                        <span class="text-sm font-medium">${m}</span>
                    </label>
                    <input type="number" placeholder="å›ºå®š$" class="custom-amount w-16 text-right text-xs bg-transparent border-b border-gray-300 custom-amount-input" title="è‹¥æ­¤äººéœ€æ”¯ä»˜å›ºå®šé‡‘é¡è«‹å¡«å¯«">
                </div>
            `).join('');

            document.getElementById('payer').innerHTML = '<option value="" disabled selected>èª°ä»˜éŒ¢ï¼Ÿ</option>' + trip.members.map(m => `<option value="${m}">${m}</option>`).join('');

            let totalSpent = 0; 
            let balances = {};
            trip.members.forEach(m => balances[m] = 0);

            const listBody = document.getElementById('expenseList');
            listBody.innerHTML = trip.data.map(item => {
                totalSpent += item.amount;
                if (balances.hasOwnProperty(item.payer)) balances[item.payer] += item.amount;

                // è¨ˆç®—åˆ†å¸³ç´°ç¯€
                let customTotal = 0;
                let customCount = 0;
                item.participants.forEach(p => {
                    if (p.customAmount !== null) {
                        customTotal += p.customAmount;
                        customCount++;
                    }
                });

                const remainingAmount = item.amount - customTotal;
                const splitCount = item.participants.length - customCount;
                const avgShare = splitCount > 0 ? remainingAmount / splitCount : 0;

                const detailTexts = item.participants.map(p => {
                    const finalShare = p.customAmount !== null ? p.customAmount : avgShare;
                    if (balances.hasOwnProperty(p.name)) balances[p.name] -= finalShare;
                    return `${p.name}($${Math.round(finalShare)})`;
                });

                return `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4 font-medium text-slate-700">${item.name}</td>
                        <td class="p-4 text-slate-600">${item.payer}</td>
                        <td class="p-4 text-xs text-gray-400 italic leading-tight">
                            ${detailTexts.join(', ')}<br>
                            <span class="text-blue-500 font-semibold text-[10px]">äººå‡ç´„: $${Math.round(item.amount/item.participants.length)}</span>
                        </td>
                        <td class="p-4 text-right font-black text-slate-900">$${item.amount.toLocaleString()}</td>
                    </tr>`;
            }).join('');

            document.getElementById('totalSpent').innerText = `$${Math.round(totalSpent).toLocaleString()}`;
            document.getElementById('balanceList').innerHTML = trip.members.map(m => {
                const b = Math.round(balances[m]);
                return `<div class="flex justify-between p-2 rounded-lg ${b>=0?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}"><span>${m}</span><b>${b>=0?'+':''}${b}</b></div>`;
            }).join('');
        }
    </script>

    <nav class="bg-white border-b p-4 no-print sticky top-0 z-10 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center">
            <div class="font-black text-blue-600 mr-6 text-lg">Paulçš„è¨˜å¸³è»Ÿé«”</div>
            <div id="tripTabs" class="flex space-x-2 overflow-x-auto flex-1 p-1"></div>
            <button onclick="createNewTrip()" class="ml-4 text-blue-600 hover:scale-110 transition"><i class="fa-solid fa-plus-circle text-2xl"></i></button>
        </div>
    </nav>

    <header class="bg-slate-900 text-white p-8 no-print shadow-inner">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 id="tripTitle" contenteditable="true" onblur="updateTripName()" class="text-3xl font-black cursor-text p-1 rounded" title="é»æ“Šç›´æ¥ä¿®æ”¹å°ˆæ¡ˆåç¨±">è¼‰å…¥ä¸­...</h1>
            <button onclick="window.print()" class="bg-blue-600 px-6 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 transition">åŒ¯å‡ºå ±è¡¨</button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6 no-print">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-700 mb-4">ğŸ‘¥ åƒèˆ‡åˆ†å¸³äººå“¡</h3>
                <div id="memberList" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2"><input id="newMemberName" type="text" placeholder="å§“å" class="flex-1 border p-2 rounded-xl bg-gray-50"><button onclick="addMember()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm">æ–°å¢</button></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-700 mb-4">ğŸ’° æ–°å¢æ¶ˆè²»</h3>
                <input id="itemName" type="text" placeholder="é …ç›® (å¦‚ï¼šæ™šé¤)" class="w-full border p-3 rounded-xl mb-3 bg-gray-50">
                <div class="flex gap-2 mb-3"><select id="payer" class="flex-1 border p-3 rounded-xl bg-gray-50"></select><input id="amount" type="number" placeholder="é‡‘é¡" class="w-24 border p-3 rounded-xl bg-gray-50"></div>
                <div class="flex justify-between items-center mb-2"><p class="text-xs text-gray-400 font-bold">åˆ†å¸³äººå“¡ / æŒ‡å®šé‡‘é¡($)</p></div>
                <div id="participantChecks" class="space-y-2 mb-4 max-h-48 overflow-y-auto pr-1"></div>
                <button onclick="addRow()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-blue-200 shadow-xl hover:bg-blue-700 transition">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>
        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-bold text-gray-700 mb-4">âš–ï¸ çµç®—</h3><div id="balanceList" class="space-y-2"></div></div>
                <div class="bg-blue-600 p-6 rounded-2xl text-white flex flex-col justify-center shadow-xl"><p class="text-blue-100">ç¸½æ”¯å‡º</p><p id="totalSpent" class="text-5xl font-black mt-2">$0</p></div>
            </div>
            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden overflow-x-auto">
                <table class="w-full text-left min-w-[500px]">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="p-4">é …ç›®</th>
                            <th class="p-4">ä»˜æ¬¾äºº</th>
                            <th class="p-4">åˆ†å¸³ç´°ç¯€ / äººå‡</th>
                            <th class="p-4 text-right">é‡‘é¡</th>
                        </tr>
                    </thead>
                    <tbody id="expenseList" class="text-gray-700"></tbody>
                </table>
            </div>
        </div>
    </main>
</body>
</html>