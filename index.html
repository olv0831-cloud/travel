<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paulçš„åˆ†å¸³ç¥å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print { .no-print { display: none !important; } }
        .active-tab { border-bottom: 4px solid #3b82f6; color: #3b82f6; background: #eff6ff; font-weight: bold; }
        .tab { transition: all 0.3s; cursor: pointer; padding: 8px 16px; border-radius: 99px; display: flex; align-items: center; gap: 8px; }
        .member-col { min-width: 85px; text-align: center; border-left: 1px solid #f1f5f9; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b p-4 no-print sticky top-0 z-10 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center">
            <div class="font-black text-blue-600 mr-6 text-lg">Paulçš„åˆ†å¸³ç¥å™¨</div>
            <div id="tripTabs" class="flex space-x-2 overflow-x-auto flex-1 p-1"></div>
            <button onclick="createNewTrip()" class="ml-4 text-blue-600 hover:scale-110 transition"><i class="fa-solid fa-plus-circle text-2xl"></i></button>
        </div>
    </nav>

    <header class="bg-slate-900 text-white p-8 no-print shadow-inner">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 id="tripTitle" contenteditable="true" onblur="updateTripName()" class="text-3xl font-black cursor-text p-1 rounded">è¼‰å…¥ä¸­...</h1>
            <div class="flex gap-2">
                <button onclick="exportToCSV()" class="bg-green-600 px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-green-700 transition"><i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å‡º CSV</button>
                <button onclick="window.print()" class="bg-blue-600 px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 transition">åˆ—å°å ±è¡¨</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-1 space-y-6 no-print">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-700 mb-4">ğŸ‘¥ åƒèˆ‡åˆ†å¸³äººå“¡</h3>
                <div id="memberList" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2"><input id="newMemberName" type="text" placeholder="å§“å" class="flex-1 border p-2 rounded-xl bg-gray-50"><button onclick="addMember()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm">æ–°å¢</button></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-700 mb-4">ğŸ’° æ–°å¢æ¶ˆè²»</h3>
                <input id="itemName" type="text" placeholder="é …ç›® (å¦‚ï¼šæ™šé¤)" class="w-full border p-3 rounded-xl mb-3 bg-gray-50">
                <div class="flex gap-2 mb-3"><select id="payer" class="flex-1 border p-3 rounded-xl bg-gray-50 text-sm"></select><input id="amount" type="number" placeholder="é‡‘é¡" class="w-24 border p-3 rounded-xl bg-gray-50"></div>
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] text-gray-400 font-bold">åˆ†å¸³äººå“¡ / å›ºå®š$</p>
                    <label class="text-[10px] text-blue-500 cursor-pointer flex items-center gap-1"><input type="checkbox" id="selectAllBtn" checked onclick="toggleAllParticipants(this)"> å…¨é¸</label>
                </div>
                <div id="participantChecks" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>
                <button onclick="addRow()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-blue-200 shadow-xl hover:bg-blue-700 transition">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>

        <div class="lg:col-span-3 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-bold text-gray-700 mb-4">âš–ï¸ çµç®— (å¤šé€€å°‘è£œ)</h3><div id="balanceList" class="space-y-2 text-sm"></div></div>
                <div class="bg-blue-600 p-6 rounded-2xl text-white flex flex-col justify-center shadow-xl"><p class="text-blue-100">ç•¶å‰å°ˆæ¡ˆç¸½æ”¯å‡º</p><p id="totalSpent" class="text-5xl font-black mt-2">$0</p></div>
            </div>
            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden overflow-x-auto">
                <table class="w-full text-left min-w-[800px]">
                    <thead id="dynamicHeader" class="bg-gray-50 text-gray-500 text-[10px] uppercase font-bold"></thead>
                    <tbody id="expenseList" class="text-gray-700 text-sm"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLz4iTnKXkba26S4fRUdV6d0DTZiRXSg0",
            authDomain: "travel-expense-7dbaa.firebaseapp.com",
            projectId: "travel-expense-7dbaa",
            storageBucket: "travel-expense-7dbaa.firebasestorage.app",
            messagingSenderId: "745263115640",
            appId: "1:745263115640:web:5714e2c1d041969ecaec8d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tripsRef = doc(db, "travelData", "master_record");

        window.trips = [];
        window.currentTripId = localStorage.getItem('current_trip_id') || "";

        onSnapshot(tripsRef, (docSnap) => {
            if (docSnap.exists()) {
                window.trips = docSnap.data().trips || [];
                // è‡ªå‹•ä¿®å¾©èˆŠè³‡æ–™æ ¼å¼
                window.trips.forEach(trip => {
                    trip.data.forEach(item => {
                        item.participants = item.participants.map(p => 
                            typeof p === 'string' ? { name: p, customAmount: null } : p
                        );
                    });
                });
            } else {
                window.trips = [{ id: Date.now(), name: 'æˆ‘çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆ', members: ['Paul'], data: [] }];
                setDoc(tripsRef, { trips: window.trips });
            }
            if (!window.currentTripId && window.trips.length > 0) window.currentTripId = window.trips[0].id;
            refreshAll();
        });

        async function sync() { await setDoc(tripsRef, { trips: window.trips }); }

        window.toggleAllParticipants = (source) => {
            document.querySelectorAll('.participant-checkbox').forEach(cb => cb.checked = source.checked);
        };

        window.deleteExpense = async (expenseId) => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            if (trip && confirm("ç¢ºå®šåˆªé™¤é€™ç­†å¸³ç›®ï¼Ÿ")) {
                trip.data = trip.data.filter(item => item.id !== expenseId);
                await sync();
            }
        };

        window.exportToCSV = () => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            let csv = "é …ç›®,ä»˜æ¬¾äºº,é‡‘é¡," + trip.members.join(",") + "\n";
            trip.data.forEach(item => {
                let row = `${item.name},${item.payer},${item.amount}`;
                trip.members.forEach(m => {
                    const p = item.participants.find(part => part.name === m);
                    row += p ? `,${Math.round(p.finalShare || 0)}` : ",0";
                });
                csv += row + "\n";
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${trip.name}_åˆ†å¸³.csv`;
            link.click();
        };

        window.addRow = async () => {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId));
            const name = document.getElementById('itemName').value;
            const payer = document.getElementById('payer').value;
            const totalAmount = parseFloat(document.getElementById('amount').value);
            const participants = [];
            let totalCustom = 0;
            
            document.querySelectorAll('.participant-row').forEach(row => {
                const cb = row.querySelector('.participant-checkbox');
                const customInput = row.querySelector('.custom-amount');
                if (cb.checked) {
                    const customVal = parseFloat(customInput.value) || 0;
                    participants.push({ name: cb.value, customAmount: customVal > 0 ? customVal : null });
                    totalCustom += customVal;
                }
            });

            if (name && payer && !isNaN(totalAmount) && participants.length > 0) {
                if (totalCustom > totalAmount) return alert("è‡ªè¨‚é‡‘é¡ç¸½å’Œä¸èƒ½è¶…éç¸½é‡‘é¡ï¼");
                const customCount = participants.filter(p => p.customAmount !== null).length;
                const remaining = totalAmount - totalCustom;
                const splitCount = participants.length - customCount;
                const avg = splitCount > 0 ? remaining / splitCount : 0;
                participants.forEach(p => { p.finalShare = p.customAmount !== null ? p.customAmount : avg; });
                
                trip.data.push({ id: Date.now(), name, payer, amount: totalAmount, participants });
                document.getElementById('itemName').value = '';
                document.getElementById('amount').value = '';
                await sync();
            }
        };

        window.updateTripName = async () => { 
            const el = document.getElementById('tripTitle'); 
            const newName = el.innerText.trim(); 
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId)); 
            if (trip && newName && trip.name !== newName && newName !== "è¼‰å…¥ä¸­...") { 
                trip.name = newName; 
                await sync(); 
            } 
        };
        window.addMember = async () => { const name = document.getElementById('newMemberName').value.trim(); const trip = window.trips.find(t => String(t.id) === String(window.currentTripId)); if (name && !trip.members.includes(name)) { trip.members.push(name); document.getElementById('newMemberName').value = ''; await sync(); } };
        window.removeMember = async (name) => { const trip = window.trips.find(t => String(t.id) === String(window.currentTripId)); if (confirm(`ç§»é™¤ã€Œ${name}ã€ï¼Ÿ`)) { trip.members = trip.members.filter(m => m !== name); await sync(); } };
        window.switchTrip = (id) => { window.currentTripId = id; localStorage.setItem('current_trip_id', id); refreshAll(); };
        window.deleteTrip = async (e, id) => { e.stopPropagation(); if (confirm(`ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿ`)) { window.trips = window.trips.filter(t => t.id !== id); window.currentTripId = window.trips.length > 0 ? window.trips[0].id : ""; await sync(); } };
        window.createNewTrip = async () => { const name = prompt('æ–°å°ˆæ¡ˆåç¨±ï¼š', 'æ–°è¨ˆç•«'); if (name) { const newTrip = { id: Date.now(), name, members: ['Paul'], data: [] }; window.trips.push(newTrip); window.currentTripId = newTrip.id; await sync(); } };

        function refreshAll() {
            const trip = window.trips.find(t => String(t.id) === String(window.currentTripId)) || window.trips[0];
            if (!trip) return;

            document.getElementById('tripTitle').innerText = trip.name;
            document.getElementById('tripTabs').innerHTML = window.trips.map(t => `<div onclick="switchTrip(${t.id})" class="tab ${String(t.id) === String(window.currentTripId) ? 'active-tab shadow-sm' : 'text-gray-400'} group"><span>${t.name}</span><i onclick="deleteTrip(event, ${t.id})" class="fa-solid fa-trash-can text-[10px] hover:text-red-500 opacity-0 group-hover:opacity-100 transition"></i></div>`).join('');
            document.getElementById('memberList').innerHTML =